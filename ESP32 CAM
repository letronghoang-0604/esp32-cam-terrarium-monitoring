
// File: ESP32-CAM.ino (Giao diá»‡n cá»•ng 80, MJPEG stream cá»•ng 81)

#include "esp_camera.h"
#include <WiFi.h>
#include <WebServer.h>
#include "index_html.h" // TÃ¡ch giao diá»‡n web
#include "esp_http_server.h"
#include <DHT.h>
#include <Preferences.h>

Preferences prefs;
int thres_temp = 0;
int thres_humi = 0;
int thres_soil = 0;
String current_env = "";
unsigned long lastSoilRead = 0;
int lastSoilPercent = 0;

#define CAMERA_MODEL_AI_THINKER // Has PSRAM
#include "camera_pins.h"

// ThÃ´ng tin WiFi
const char* ssid = "D906_TEC";
const char* password = "D906_TEC";
// Cáº¥u hÃ¬nh Ä‘á»‹a chá»‰ IP tÄ©nh (pháº£i há»£p lá»‡: má»—i giÃ¡ trá»‹ tá»« 0 Ä‘áº¿n 255)
IPAddress local_IP(172, 16, 36, 200); // Äá»‹a chá»‰ IP tÄ©nh mong muá»‘n
IPAddress gateway(172, 16, 36, 1); // Äá»‹a chá»‰ gateway cá»§a router
IPAddress subnet(255, 255, 255, 0); // Máº·t náº¡ máº¡ng (subnet mask)

// ================= Cáº¤U HÃŒNH CHÃ‚N =================
#define DHTPIN     14        // ChÃ¢n káº¿t ná»‘i DHT22
#define SOIL_PIN   15        // ChÃ¢n analog cáº£m biáº¿n Ä‘á»™ áº©m Ä‘áº¥t
#define SERVO_PIN  13
#define SERVO_CHANNEL 3        // DÃ¹ng kÃªnh PWM 3, trÃ¡nh trÃ¹ng vá»›i camera
int soil_raw = 0;
int soil_percent = 0;

#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);
int servo_pos = 90; // GÃ³c máº·c Ä‘á»‹nh
unsigned long lastAutoCheck = 0;
bool autoLightOn = false;
bool autoFanOn = false;
bool autoPumpOn = false;

WebServer server(80);
httpd_handle_t stream_httpd = NULL;

void startCameraServer();


esp_err_t stream_handler(httpd_req_t *req) {
  camera_fb_t *fb = NULL;
  esp_err_t res = ESP_OK;
  res = httpd_resp_set_type(req, "multipart/x-mixed-replace; boundary=frame");
  while (true) {
    fb = esp_camera_fb_get();
    if (!fb) {
      Serial.println("Camera capture failed");
      continue;
    }
    char buf[64];
    size_t len = snprintf(buf, 64,
      "--frame\r\nContent-Type: image/jpeg\r\nContent-Length: %u\r\n\r\n", fb->len);
    res = httpd_resp_send_chunk(req, buf, len);
    res = httpd_resp_send_chunk(req, (const char*)fb->buf, fb->len);
    res = httpd_resp_send_chunk(req, "\r\n", 2);
    esp_camera_fb_return(fb);
    if (res != ESP_OK) break;
  }
  return res;
}

void startCameraServer() {
  httpd_config_t config = HTTPD_DEFAULT_CONFIG();
  config.server_port = 81;

  httpd_uri_t stream_uri = {
    .uri       = "/stream",
    .method    = HTTP_GET,
    .handler   = stream_handler,
    .user_ctx  = NULL
  };

  if (httpd_start(&stream_httpd, &config) == ESP_OK) {
    httpd_register_uri_handler(stream_httpd, &stream_uri);
  }
}

void setup() {
  Serial.begin(115200);
// Khá»Ÿi táº¡o UART2: TX = GPIO2, khÃ´ng cáº§n RX
Serial2.begin(9600, SERIAL_8N1, -1, 2); // RX = -1 (khÃ´ng dÃ¹ng), TX = GPIO16

prefs.begin("env_cfg", true);  // true = chá»‰ Ä‘á»c
thres_temp = prefs.getInt("temp", 0);
thres_humi = prefs.getInt("humi", 0);
thres_soil = prefs.getInt("soil", 0);
current_env = prefs.getString("env", "");
prefs.end();


Serial.printf("NgÆ°á»¡ng khá»Ÿi Ä‘á»™ng láº¡i | MÃ´i trÆ°á»ng: %s | Nhiá»‡t: %d | áº¨m: %d | Äáº¥t: %d\n",
  current_env.c_str(), thres_temp, thres_humi, thres_soil);

if (!WiFi.config(local_IP, gateway, subnet)) {
Serial.println("âš ï¸ Cáº¥u hÃ¬nh IP tÄ©nh tháº¥t báº¡i!");
}

soil_raw = analogRead(SOIL_PIN);  
soil_percent = 87;
Serial.printf("Soil: raw = %d â†’ %d%%\n", soil_raw, soil_percent);

WiFi.begin(ssid, password);
Serial.print("ğŸ”Œ Äang káº¿t ná»‘i WiFi");

while (WiFi.status() != WL_CONNECTED) {
delay(500);
Serial.print(".");
}

Serial.println("\nâœ… ÄÃ£ káº¿t ná»‘i WiFi");
Serial.print("ğŸ“¡ IP tÄ©nh: ");
Serial.println(WiFi.localIP());

  camera_config_t config;
  config.ledc_channel = LEDC_CHANNEL_0;
  config.ledc_timer = LEDC_TIMER_0;
  config.pin_d0 = Y2_GPIO_NUM;
  config.pin_d1 = Y3_GPIO_NUM;
  config.pin_d2 = Y4_GPIO_NUM;
  config.pin_d3 = Y5_GPIO_NUM;
  config.pin_d4 = Y6_GPIO_NUM;
  config.pin_d5 = Y7_GPIO_NUM;
  config.pin_d6 = Y8_GPIO_NUM;
  config.pin_d7 = Y9_GPIO_NUM;
  config.pin_xclk = XCLK_GPIO_NUM;
  config.pin_pclk = PCLK_GPIO_NUM;
  config.pin_vsync = VSYNC_GPIO_NUM;
  config.pin_href = HREF_GPIO_NUM;
  config.pin_sscb_sda = SIOD_GPIO_NUM;
  config.pin_sscb_scl = SIOC_GPIO_NUM;
  config.pin_pwdn = PWDN_GPIO_NUM;
  config.pin_reset = RESET_GPIO_NUM;
  config.xclk_freq_hz = 20000000;
  config.pixel_format = PIXFORMAT_JPEG;
  config.frame_size = FRAMESIZE_QVGA;
  config.jpeg_quality = 12;
  config.fb_count = 2;

  if (esp_camera_init(&config) != ESP_OK) {
    Serial.println("Camera init failed");
    return;
  }

  dht.begin();
// Ngáº¯t flash náº¿u Ä‘ang dÃ¹ng GPIO13
pinMode(SERVO_PIN, OUTPUT);
digitalWrite(SERVO_PIN, LOW);
ledcDetachPin(SERVO_PIN);   // Ráº¥t quan trá»ng náº¿u GPIO13 tá»«ng lÃ  flash

// Cáº¥u hÃ¬nh PWM servo
ledcSetup(SERVO_CHANNEL, 50, 16);         // Táº§n sá»‘ 50Hz, 16-bit Ä‘á»™ phÃ¢n giáº£i
ledcAttachPin(SERVO_PIN, SERVO_CHANNEL);  // GÃ¡n kÃªnh PWM vÃ o chÃ¢n servo

// Quay servo vá» gÃ³c ban Ä‘áº§u (90 Ä‘á»™)
int duty = map(servo_pos, 0, 180, 1638, 7864);  // 0.5ms Ä‘áº¿n 2.4ms
ledcWrite(SERVO_CHANNEL, duty);
Serial.println("Servo Ä‘Ã£ khá»Ÿi Ä‘á»™ng vá» 90Â°");

  delay(500);                     // Chá» servo quay (tÃ¹y Ã½, 0.5 giÃ¢y)


  server.on("/", HTTP_GET, []() {
    String html(index_html);
    html.replace("%IP%", WiFi.localIP().toString());
    server.send(200, "text/html", html);
  });

// Xá»­ lÃ½ yÃªu cáº§u quay servo tá»« web
server.on("/cmd", HTTP_GET, []() {
  String act = server.arg("act");
  if (act == "rotate_left") {
    servo_pos = constrain(servo_pos - 15, 0, 180);
  } else if (act == "rotate_right") {
    servo_pos = constrain(servo_pos + 15, 0, 180);
  }

  int duty = map(servo_pos, 0, 180, 1638, 7864);  // PWM SG90 tá»« 0.5ms Ä‘áº¿n 2.4ms
  ledcWrite(SERVO_CHANNEL, duty);
  Serial.printf("Servo moved to %dÂ°\n", servo_pos);

  server.send(200, "text/plain", "OK");
});

  
  // Ä‘iá»u chá»‰nh vÃ  lÆ°u ngÆ°á»¡ng
  server.on("/setenv", HTTP_GET, []() {
  thres_temp = server.arg("t").toInt();
  thres_humi = server.arg("h").toInt();
  thres_soil = server.arg("s").toInt();
  current_env = server.arg("env");

  // Ghi vÃ o flash
  prefs.begin("env_cfg", false);  // false = ghi
  prefs.putInt("temp", thres_temp);
  prefs.putInt("humi", thres_humi);
  prefs.putInt("soil", thres_soil);
  prefs.putString("env", current_env);
  prefs.end();

  Serial.printf("ÄÃ£ lÆ°u ngÆ°á»¡ng | MÃ´i trÆ°á»ng: %s | Nhiá»‡t: %d | áº¨m: %d | Äáº¥t: %d\n",
    current_env.c_str(), thres_temp, thres_humi, thres_soil);
  server.send(200, "text/plain", "NgÆ°á»¡ng Ä‘Ã£ lÆ°u");
});

// gá»­i dá»¯ liá»‡u lÃªn web
server.on("/getdata", HTTP_GET, []() {
float t = dht.readTemperature();       // Äá»c nhiá»‡t Ä‘á»™ tá»« DHT22
float h = dht.readHumidity();          // Äá»c Ä‘á»™ áº©m tá»« DHT22

String json = "{";
json += "\"temp\":" + String(t, 1) + ",";
json += "\"humi\":" + String(h, 1) + ",";
json += "\"soil\":" + String(soil_percent);
json += "}";

Serial.printf("DHT22 | Temp: %.1fÂ°C | Humi: %.1f%% | Soil Moisture: %d%%\n", t, h, soil_percent);

Serial.println("Dá»¯ liá»‡u JSON gá»­i vá» web:");
Serial.println(json);

server.send(200, "application/json", json);
  });
  server.on("/cmd", HTTP_GET, []() {
    String act = server.arg("act");
    server.send(200, "text/plain", "OK");
  });

server.onNotFound([]() {
  Serial.print("ğŸ” Web gá»­i yÃªu cáº§u: ");
  Serial.println(server.uri());
  server.send(404, "text/plain", "Not found");
});

server.on("/relay", HTTP_GET, []() {
  int id = server.arg("id").toInt();
  String state = server.arg("state");  // "on" hoáº·c "off"

  if (id >= 1 && id <= 3 && (state == "on" || state == "off")) {
    // Gá»­i qua UART2: VD "RELAY1_ON\n"
    String uartCmd = "RELAY" + String(id) + "_" + (state == "on" ? "ON" : "OFF") + "\n";
    Serial2.print(uartCmd);
    Serial.printf("ğŸ“¤ UART gá»­i: %s", uartCmd.c_str());
    server.send(200, "text/plain", "UART sent");
  } else {
    server.send(400, "text/plain", "ID hoáº·c state khÃ´ng há»£p lá»‡");
  }
});




  server.begin();
  startCameraServer();
  Serial.println("Server started");

}
void loop() {
  server.handleClient();

 unsigned long now = millis();
  if (now - lastAutoCheck > 3000) {  // má»—i 3 giÃ¢y
    lastAutoCheck = now;

    float t = dht.readTemperature();
    float h = dht.readHumidity();
    int soil = analogRead(SOIL_PIN);
    int soil_percent = map(soil, 0, 4095, 0, 100);

    Serial.printf("ğŸŒ¡ï¸ Tá»± Ä‘á»™ng kiá»ƒm tra | Temp: %.1fÂ°C | Humi: %.1f%% | Soil: %d%%\n", t, h, soil_percent);

    // Äiá»u khiá»ƒn ÄÃ¨n, quáº¡t (RELAY1,2) - nhiá»‡t Ä‘á»™ tháº¥p, cao
    if (t < thres_temp - 2) {
      if (!autoLightOn) {
        Serial2.print("RELAY1_ON\n");
        Serial.println("ğŸ”† Tá»± Ä‘á»™ng Báº¬T Ä‘Ã¨n");
        autoLightOn = true;
      }
    } else if (t > thres_temp + 2) {
      if (autoLightOn) {
        Serial2.print("RELAY2_ON\n");
        Serial.println("ğŸ”† Tá»± Ä‘á»™ng báº­t quáº¡t");
        autoLightOn = false;
      }
    } else if (thres_temp - 2 < t < thres_temp + 2) {
      if (autoLightOn) {
        Serial2.print("RELAY1_OFF\n");
        Serial2.print("RELAY2_OFF\n");
        Serial.println("ğŸ”† Tá»± Ä‘á»™ng Táº®T Ä‘Ã¨n, quáº¡t");
        autoLightOn = false;
      }
    }

    // Äiá»u khiá»ƒn Quáº¡t (RELAY2) - Ä‘á»™ áº©m khÃ´ng khÃ­ cao
    if (h > thres_humi + 5) {
      if (!autoFanOn) {
        Serial2.print("RELAY2_ON\n");
        Serial.println("ğŸ’¨ Tá»± Ä‘á»™ng Báº¬T quáº¡t");
        autoFanOn = true;
      }
    } else if (h <= thres_humi) {
      if (autoFanOn) {
        Serial2.print("RELAY2_OFF\n");
        Serial.println("ğŸ’¨ Tá»± Ä‘á»™ng Táº®T quáº¡t");
        autoFanOn = false;
      }
    }

    // Äiá»u khiá»ƒn BÆ¡m (RELAY3) - Ä‘áº¥t khÃ´
    if (soil_percent < thres_soil - 10) {
      if (!autoPumpOn) {
        Serial2.print("RELAY3_ON\n");
        Serial.println("ğŸ’§ Tá»± Ä‘á»™ng Báº¬T bÆ¡m");
        autoPumpOn = true;
      }
    } else if (soil_percent >= thres_soil) {
      if (autoPumpOn) {
        Serial2.print("RELAY3_OFF\n");
        Serial.println("ğŸ’§ Tá»± Ä‘á»™ng Táº®T bÆ¡m");
        autoPumpOn = false;
      }
    }
  }

}
