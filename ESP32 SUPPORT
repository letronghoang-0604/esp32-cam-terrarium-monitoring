#include <HardwareSerial.h>

HardwareSerial SerialNode(1);  // UART1

#define RXD1 16   // Nh·∫≠n t·ª´ TX ESP32-CAM
#define TXD1 -1   // Kh√¥ng d√πng TX

#define LIGHT_PIN 5   // GPIO5
#define FAN_PIN   18   // GPIO18
#define PUMP_PIN  19   // GPIO19

String inputString = "";

void setup() {
  Serial.begin(115200);  // Debug USB
  SerialNode.begin(9600, SERIAL_8N1, RXD1, TXD1);  // UART nh·∫≠n d·ªØ li·ªáu

  pinMode(LIGHT_PIN, OUTPUT);
  pinMode(FAN_PIN, OUTPUT);
  pinMode(PUMP_PIN, OUTPUT);

  digitalWrite(LIGHT_PIN, HIGH);
  digitalWrite(FAN_PIN, HIGH);
  digitalWrite(PUMP_PIN, HIGH);

  Serial.println("‚úÖ ESP32 DevKit s·∫µn s√†ng.");
}

void loop() {
  while (SerialNode.available()) {
    char ch = SerialNode.read();

    // ‚úÖ C√°ch 1: L·ªçc k√Ω t·ª± kh√¥ng in ƒë∆∞·ª£c
    if ((ch >= 32 && ch <= 126) || ch == '\n') {
      inputString += ch;
    }

    // Khi nh·∫≠n k√Ω t·ª± xu·ªëng d√≤ng => x·ª≠ l√Ω l·ªánh
    if (ch == '\n') {
      inputString.trim();

      // ‚úÖ C√°ch 2: Lo·∫°i b·ªè k√Ω t·ª± l·∫° c√≤n s√≥t trong chu·ªói
      String cleanedCmd = "";
      for (int i = 0; i < inputString.length(); i++) {
        char c = inputString.charAt(i);
        if (c >= 32 && c <= 126) cleanedCmd += c;
      }

      handleCommand(cleanedCmd);
      inputString = "";
    }
  }
}

void handleCommand(String cmd) {
  Serial.print("üì• Nh·∫≠n l·ªánh: ");
  Serial.println(cmd);

  if (cmd == "RELAY1_ON") {
    digitalWrite(LIGHT_PIN, LOW);
    Serial.println("üí° B·∫≠t ƒë√®n");
  } else if (cmd == "RELAY1_OFF") {
    digitalWrite(LIGHT_PIN, HIGH);
    Serial.println("üí° T·∫Øt ƒë√®n");

  } else if (cmd == "RELAY2_ON") {
    digitalWrite(FAN_PIN, LOW);
    Serial.println("üåÄ B·∫≠t qu·∫°t");
  } else if (cmd == "RELAY2_OFF") {
    digitalWrite(FAN_PIN, HIGH);
    Serial.println("üåÄ T·∫Øt qu·∫°t");

  } else if (cmd == "RELAY3_ON") {
    digitalWrite(PUMP_PIN, LOW);
    Serial.println("üíß B·∫≠t b∆°m");
  } else if (cmd == "RELAY3_OFF") {
    digitalWrite(PUMP_PIN, HIGH);
    Serial.println("üíß T·∫Øt b∆°m");

  } else {
    Serial.println("‚ö†Ô∏è L·ªánh kh√¥ng h·ª£p l·ªá");
  }
}
